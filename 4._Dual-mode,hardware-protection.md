## 이중모드, 하드웨어 보호

### 1. 이중모드 (dual mode)

- 한 컴퓨터를 여러 사람이 동시에 사용하는 환경 (ex. 서버 컴퓨터, 수강 신청) 또는 한 사람이 여러 프로그램을 동시에 사용(ex. 스마트폰)하는 경우
- 한 사람이 여러 프로그램을 동시에 사용하는 환경에서는 한 사람의 행동이 프로그램 전체에 영향을 줄 수 있다. (실수, 또는 고의로 잘못된 명령을 입력했을 때 시스템이 다운되는 경우)

  **특권 명령어(privileged instructions) 종류** : STOP, HALT, RESET, SET_TIMER, SET_HW 등의

- 사용자 프로그램은 특별한 권한이 있는 명령(privileged instructions)을 사용 불가하게 해야한다. (일반 유저가 사용하지 못하게)

  **사용자(user) 모드(일반 user)** vs **관리자(supervisor) 모드**의 **이중모드(dual mode)**를 사용한다.

  관리자 모드(supervisor mode) = 시스템 모드(system mode) = 모니터 모드(monitor mode) = 특권 모드(privileged mode)

- **특권 명령(privileged instructions)** : 관리자 모드에서만 내릴 수 있는 명령 (일반 유저 X)  
  하드웨어의 값을 바꾸는 것도 일반 유저가 하면 안된다. -> 다른 유저에게 영향을 끼칠 수 있기 때문에

### 2. 이중모드는 어떻게 구현할 수 있는가?

- 이중 모드를 나타내는 비트를 추가, 레지스터 안에 있는 비트를 모니터 비트에 할당

  **모니터 비트**

  - 1 -> **시스템 모드(privileged instruction)**
  - 0 -> **user mode**

- cpu 내에는 레지스터, ALU, control unit 등 존재 -> 레지스터에 모드를 나타내는 flag 존재(**flag - carry, overflow, zero, negative** (0과 1로 기능이 정해짐)
  -> 일반 유저가 privileged instruction을 내리려고 하면 내부적으로 인터럽트가 발생한다.

|                 관리자 모드                  |              사용자 모드               |
| :------------------------------------------: | :------------------------------------: |
|          운영체제 서비스 실행될 때           |       사용자 프로그램 실행할 때        |
| 하드웨어 / 소프트웨어 인터럽트 발생하는 경우 | 운영체제 서비스가 끝나면 다시 돌아온다 |

- 일반 user program이 하드 디스크에 접근할 수 있다는 것은 하드디스크 안의 다른 사용자의 파일을 건드릴 수 있다는 것이다. -> 보안에 큰 문제  
  -> software interrupt를 사용해서(ISR) 내가 디스크에 저장하고 싶은 것을 저장

- user mode -> (키보드, 마우스) -> system mode(ISR) -> (OS 동작)-> user mode -> (모니터, 디스크, 프린터) -- 인터럽트 --> system mode -> user mode

### 3. 하드웨어 보호

#### 1. 입출력장치 보호

- 사용자의 잘못된 입출력 명령
  - 다른 사용자의 입출력, 정보 등에 방해  
    ex) 프린트, 혼선, 리셋 등, 하드디스크에 접근해 다른 사람의 파일을 읽고 쓰는 것

#### 해결법

- 입출력 명령을 특권 명령(privileged instruction )으로 지정한다. (ex. IN, OUT) -> 일반 유저가 접근 시 강제 종료
- 입출력을 하려면 운영체제에게 요청하고 (**system mode 전환**), 운영체제가 입출력 대행(software interrupt), 마친 후 다시 **user mode 복귀**
- 올바른 요청이 아니면 운영체제가 거부(하드 디스크 자체를 읽지 않는다.) / 특권 명령을 침범(privileged instruction violation)

#### 2. 메모리 보호

- 다른 사용자 메모리 또는 운영체제 영역 메모리 접근
  - 우연히 또는 고의로
  - 다른 사용자(user1가 user 2, 3의 정보를 읽으려고 하는 경우) 정보 / 프로그램에 대한 해킹
  - 운영체제 해킹

#### 해결법

- MMU(Memory Management Unit, ex. 문지기)를 두어 다른 메모리 영역을 침범하는지 감시하도록한다.
- **MMU 설정은 특권명령** : 즉, 운영체제만 바꿀 수 있다. (base, limit)
- **segment violation** : 다른 사용자 또는 운영체제 영역 메모리에 접근을 시도하는 것

#### 3. CPU 보호
